from __future__ import annotations

"""Le√ßon et quiz sur l'imparfait et le pass√© simple."""

DISPLAY_NAME = "Fran√ßais : Imparfait ou pass√© simple ?"

from .logger import log_result
from .utils import show_lesson

LESSON = """
üìö **L'imparfait et le pass√© simple : deux temps du r√©cit**

Dans un r√©cit au pass√©, on rencontre tr√®s souvent **l'imparfait** et le **pass√© simple**.
Ils ne racontent pas la m√™me chose :

- L'**imparfait** d√©crit un d√©cor, une habitude, une action qui dure ou se r√©p√®te.
  On peut souvent le remplacer par ¬´‚ÄØpendant que‚ÄØ¬ª, ¬´‚ÄØtous les‚Ä¶‚ÄØ¬ª, ¬´‚ÄØhabituellement‚ÄØ¬ª.
  Exemple : ¬´‚ÄØLe vent soufflait et la pluie tombait.‚ÄØ¬ª
- Le **pass√© simple** exprime une action ponctuelle et achev√©e, un √©v√©nement qui fait
  avancer l'histoire. On peut souvent le remplacer par ¬´‚ÄØsoudain‚ÄØ¬ª, ¬´‚ÄØalors‚ÄØ¬ª, ¬´‚ÄØtout √† coup‚ÄØ¬ª.
  Exemple : ¬´‚ÄØSoudain, la porte s'ouvrit.‚ÄØ¬ª

üéØ **Astuces pour choisir le bon temps**

1. Observe si l'action est en arri√®re-plan (imparfait) ou au premier plan (pass√© simple).
2. Demande-toi si elle dure dans le temps ou si elle est br√®ve et unique.
3. Regarde les marqueurs temporels : ¬´‚ÄØchaque matin‚ÄØ¬ª, ¬´‚ÄØsouvent‚ÄØ¬ª ‚Üí imparfait ;
   ¬´‚ÄØce jour-l√†‚ÄØ¬ª, ¬´‚ÄØpuis‚ÄØ¬ª, ¬´‚ÄØtout √† coup‚ÄØ¬ª ‚Üí pass√© simple.
4. Dans un m√™me paragraphe, l'imparfait installe le d√©cor et le pass√© simple raconte les actions principales.

‚úçÔ∏è **Conjugaison rapide**

- Imparfait : radical de la 1re personne du pluriel au pr√©sent + terminaison (-ais, -ais,
  -ait, -ions, -iez, -aient).
  > nous chantons ‚Üí je chantais, nous chantions
- Pass√© simple des verbes du 1er groupe (-er) : -ai, -as, -a, -√¢mes, -√¢tes, -√®rent.
  > il marcha, nous parl√¢mes
- Pass√© simple du 2e groupe (-ir) : -is, -is, -it, -√Æmes, -√Ætes, -irent.
  > ils finirent
- Pass√© simple des verbes du 3e groupe varie davantage : ¬´‚ÄØje pris‚ÄØ¬ª, ¬´‚ÄØnous v√Ænmes‚ÄØ¬ª,
  ¬´‚ÄØils purent‚ÄØ¬ª. Il faut les apprendre progressivement.

Pr√™t¬∑e ? Lis chaque phrase, choisis le temps qui convient et v√©rifie ton intuition !
"""

TENSE_INFO = {
    "imparfait": ("i", "imparfait"),
    "pass√© simple": ("p", "pass√© simple"),
    "autre": (
        "a",
        "autre temps (pr√©sent, futur, conditionnel, subjonctif, etc.)",
    ),
}


def _normalise_tense_answer(raw: str) -> str:
    """Normalise la saisie de l'√©l√®ve en renvoyant la cl√© de temps attendue."""

    answer = raw.strip().lower()
    for key, (short, label) in TENSE_INFO.items():
        if answer in {key, short, label.lower()}:
            return key
    return ""


QUESTIONS = [
    {
        "question": "1. Hier soir, le vent ___ tr√®s fort quand la fen√™tre claqua.",
        "options": ["souffla", "soufflait", "soufflera"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 1,
        "context": "La description du vent qui dure dans le temps prend l'imparfait.",
    },
    {
        "question": "2. Tout √† coup, le chat ___ sur la table et renversa le vase.",
        "options": ["saute", "sautait", "sauta"],
        "tenses": ["autre", "imparfait", "pass√© simple"],
        "answer": 2,
        "context": "Action br√®ve et ponctuelle ‚Üí pass√© simple.",
    },
    {
        "question": "3. Chaque √©t√©, nous ___ chez nos cousins √† la campagne.",
        "options": ["all√¢mes", "allions", "irons"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 1,
        "context": "Habitude r√©p√©t√©e, on utilise l'imparfait.",
    },
    {
        "question": "4. Soudain, il ___ une lumi√®re au loin.",
        "options": ["apercevait", "aper√ßut", "apercevra"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 1,
        "context": "La d√©couverte ponctuelle est exprim√©e au pass√© simple.",
    },
    {
        "question": "5. Pendant que les enfants ___, la pluie commen√ßa √† tomber.",
        "options": ["jou√®rent", "jouaient", "joueront"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 1,
        "context": "Action en cours de d√©roulement : imparfait.",
    },
    {
        "question": "6. Ce matin-l√†, Marie ___ la porte et sortit sans bruit.",
        "options": ["fermait", "ferma", "fermerait"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 1,
        "context": "Action principale unique ‚Üí pass√© simple.",
    },
    {
        "question": "7. Quand j'√©tais petit, je ___ des ch√¢teaux de sable pendant des heures.",
        "options": ["construisis", "construisais", "construirai"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 1,
        "context": "Souvenir prolong√©, donc imparfait.",
    },
    {
        "question": "8. Il ___ soudain que quelqu'un frappait √† la porte.",
        "options": ["sentait", "sentit", "sentira"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 1,
        "context": "Perception ponctuelle ‚Üí pass√© simple.",
    },
    {
        "question": "9. Le soleil ___ derri√®re les collines tandis que nous rentrions.",
        "options": ["disparaissait", "disparut", "dispara√Ætra"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 0,
        "context": "D√©cor en arri√®re-plan ‚Üí imparfait.",
    },
    {
        "question": "10. √Ä ce moment pr√©cis, elle ___ son sac et partit.",
        "options": ["prit", "prenait", "prendra"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 0,
        "context": "Action qui fait avancer l'histoire, donc pass√© simple.",
    },
    {
        "question": "11. Les oiseaux ___ doucement pendant que l'aube se levait.",
        "options": ["chant√®rent", "chantaient", "chanteront"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 1,
        "context": "Description d'arri√®re-plan ‚Üí imparfait.",
    },
    {
        "question": "12. Tout √† coup, la terre ___ et la foule paniqua.",
        "options": ["trembla", "tremblait", "tremblera"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 0,
        "context": "√âv√©nement unique : pass√© simple.",
    },
    {
        "question": "13. Chaque dimanche, ils ___ leurs grands-parents.",
        "options": ["visitaient", "visit√®rent", "visiteront"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 0,
        "context": "Habitude r√©guli√®re ‚Üí imparfait.",
    },
    {
        "question": "14. Il ___ puis referma la lettre avec soin.",
        "options": ["lut", "lisait", "lira"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 0,
        "context": "Action ponctuelle principale ‚Üí pass√© simple.",
    },
    {
        "question": "15. Dans le jardin, les fleurs ___ et embaumaient l'air.",
        "options": ["s'ouvriraient", "s'ouvrirent", "s'ouvraient"],
        "tenses": ["autre", "pass√© simple", "imparfait"],
        "answer": 2,
        "context": "Description du d√©cor ‚Üí imparfait.",
    },
    {
        "question": "16. Quand la cloche ___, les √©l√®ves se lev√®rent d'un bond.",
        "options": ["sonna", "sonnait", "sonnerait"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 0,
        "context": "Signal ponctuel ‚Üí pass√© simple.",
    },
    {
        "question": "17. La vieille pendule ___ toujours la m√™me chanson.",
        "options": ["jouait", "joua", "jouera"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 0,
        "context": "Habitude durable ‚Üí imparfait.",
    },
    {
        "question": "18. Ce jour-l√†, nous ___ la v√©rit√© sur leur voyage.",
        "options": ["apprenions", "appr√Æmes", "apprendrons"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 1,
        "context": "R√©v√©lation unique ‚Üí pass√© simple.",
    },
    {
        "question": "19. Les vagues ___ sans rel√¢che contre les rochers.",
        "options": ["se bris√®rent", "se brisaient", "se briseront"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 1,
        "context": "Action longue et r√©p√©t√©e ‚Üí imparfait.",
    },
    {
        "question": "20. Apr√®s un long silence, il ___ enfin quelques mots.",
        "options": ["pronon√ßait", "pronon√ßa", "prononcera"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 1,
        "context": "Action br√®ve qui survient soudainement ‚Üí pass√© simple.",
    },
    {
        "question": "21. Quand nous √©tions en classe de neige, il ___ presque tous les jours.",
        "options": ["neigea", "neigeait", "neigera"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 1,
        "context": "Fr√©quence r√©p√©t√©e ‚Üí imparfait.",
    },
    {
        "question": "22. √Ä l'annonce du r√©sultat, elle ___ de joie.",
        "options": ["sauta", "sautait", "saute"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 0,
        "context": "R√©action unique ‚Üí pass√© simple.",
    },
    {
        "question": "23. Dans la for√™t, les feuilles ___ sous nos pas.",
        "options": ["craquaient", "craqu√®rent", "craqueront"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 0,
        "context": "D√©cor sonore continu ‚Üí imparfait.",
    },
    {
        "question": "24. Nous ___ la porte et d√©couvr√Æmes une salle √©clair√©e.",
        "options": ["ouvrions", "ouvr√Æmes", "ouvrirons"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 1,
        "context": "Action principale unique ‚Üí pass√© simple.",
    },
    {
        "question": "25. Tous les soirs, il ___ une histoire √† sa petite s≈ìur.",
        "options": ["racontait", "raconta", "racontera"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 0,
        "context": "Habitude quotidienne ‚Üí imparfait.",
    },
    {
        "question": "26. √Ä minuit, l'horloge ___ douze coups retentissants.",
        "options": ["donnait", "donna", "donnera"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 1,
        "context": "Moment pr√©cis ponctuel ‚Üí pass√© simple.",
    },
    {
        "question": "27. Les invit√©s ___ encore la salle quand la musique d√©marra.",
        "options": ["occupaient", "occup√®rent", "occuperont"],
        "tenses": ["imparfait", "pass√© simple", "autre"],
        "answer": 0,
        "context": "Action en cours pendant un autre √©v√©nement ‚Üí imparfait.",
    },
    {
        "question": "28. Ce soir-l√†, nous ___ plus tard que pr√©vu.",
        "options": ["rentr√¢mes", "rentrions", "rentrerons"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 0,
        "context": "R√©sultat ponctuel du r√©cit ‚Üí pass√© simple.",
    },
    {
        "question": "29. Les bougies ___ lentement tandis que le conteur parlait.",
        "options": ["se consum√®rent", "se consumaient", "se consumeront"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 1,
        "context": "Description continue ‚Üí imparfait.",
    },
    {
        "question": "30. Lorsque le tonnerre ___, tout le monde se tut.",
        "options": ["gronda", "grondait", "grond√¢t"],
        "tenses": ["pass√© simple", "imparfait", "autre"],
        "answer": 0,
        "context": "√âv√©nement soudain ‚Üí pass√© simple.",
    },
]


LETTERS = ["a", "b", "c", "d"]


def main() -> None:
    """Affiche la le√ßon puis propose un quiz de 30 questions."""

    show_lesson(LESSON)
    print(
        "Quiz : identifie d'abord le temps de chaque verbe (i, p, a),"
        " puis choisis la bonne r√©ponse (a, b, c‚Ä¶)."
    )
    score = 0
    for index, item in enumerate(QUESTIONS, start=1):
        question = item["question"]
        options = item["options"]
        tenses = item["tenses"]
        answer = item["answer"]
        letters = LETTERS[: len(options)]
        print(f"\nQuestion {index} : {question}")
        for letter, option in zip(letters, options):
            print(f"  {letter}. {option}")

        remaining_tenses = ["imparfait", "pass√© simple", "autre"]
        for opt_index, option in enumerate(options):
            expected_tense = tenses[opt_index]
            expected_key, expected_label = TENSE_INFO[expected_tense]
            print(f"\nüîç Quel est le temps du verbe {letters[opt_index]}. {option} ?")
            print("Choix possibles :")
            for tense_name in remaining_tenses:
                short, label = TENSE_INFO[tense_name]
                print(f"  {short}. {label}")
            raw_choice = input("Votre choix : ")
            student_choice = _normalise_tense_answer(raw_choice)
            if student_choice == expected_tense:
                print("Exact, tu as identifi√© le bon temps ! ‚úÖ")
                score += 1
            else:
                print(
                    f"Non, {option} est au {expected_label}. ({expected_key}) ‚ùå"
                )
            if expected_tense in remaining_tenses:
                remaining_tenses.remove(expected_tense)

        print("\nMaintenant, choisis le verbe qui compl√®te la phrase :")
        for letter, option in zip(letters, options):
            print(f"  {letter}. {option}")
        student = input("Votre r√©ponse : ").strip().lower()
        chosen = letters.index(student) if student in letters else -1
        correct_letter = letters[answer]
        correct_text = options[answer]
        if chosen == answer:
            print("Exact ! ‚úÖ")
            score += 1
        else:
            print(f"Non, la bonne r√©ponse √©tait {correct_letter}. {correct_text} ‚ùå")
            explanation = item.get("context")
            if explanation:
                print(f"‚ÑπÔ∏è {explanation}")

    total = len(QUESTIONS) * 4
    percentage = score / total * 100
    print(f"\nScore final : {score}/{total} ({percentage:.1f} %)")
    if percentage == 100:
        print("Bravo ! Tu ma√Ætrises parfaitement l'imparfait et le pass√© simple. üåü")
    elif percentage >= 70:
        print("Tr√®s beau r√©sultat, continue comme √ßa ! üí™")
    else:
        print(
            "Courage, relis la le√ßon et recommence : tu progresseras vite ! üìñ"
        )

    log_result("francais_imparfait_passe_simple", percentage)


if __name__ == "__main__":
    main()
